---
title: "CRMMS ESP Summary"
output: word_document #For pdf output use pdf_document and set font size in line 46 to 10, for word output use word_document and set font size in line 46 to 12.
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#This file must be in the same folder as EnsembleOutput.xlsx for the current ESP run.
#Run script CRMMS ESP Analysis and Figures.R for companion data to complete bullet points in word chunks.

#Lines to update manually:
#   41: Last month file path
#   43 - 46: Update year when rolling over tables. Do NOT update month/day. 
#   46: Update only when current date is not in the same month as the ESP run. 
#   ~136: First summary bullet point.
#   ~347: Unreg inflow bullet points.
#   Can move page breaks (currently lines ~370 and ~397) as necessary.
#   ~376: Powell min power pool bullet points.

#Once all updates are complete, click "Knit". The updated code will auto-save.

#If this is the first time using this program, you may need to install packages. If there's a yellow ribbon at the top of this panel prompting the install, click that. Otherwise, run install.packages("packagename") from the Console, Ex: install.packages("readxl"). 

#With tinytex package, you may need to run tinytex::install_tinytex() if you get errors running a pdf output. If it does not solve the error, try tinytex:::install_prebuilt(), which may take a while to run.

#R may also prompt you to install updated versions of markdown, knitr, or other packages when you first run the program. If so, click yes to install.

library(readxl)
library(tinytex)
library(flextable)
library(dplyr)
library(tibble)
library(lubridate)
library(tidyverse)
library(cowplot)
library(tidyr)
library(reshape2)
library(ggpattern)

Last_month_file <- "N:/COM460/RiverWare Models/Monthly Models/CRMMS/2023/08-August/Output Data/EnsembleOutput.xlsx"       #In file path use either / or \\, do NOT use \

EOCY <- "2023-12-01"            #EOCY for Powell/Mead elevation ranges in summary points.
PowellOT_WYrn <- "2024-01-01"   #WY for Powell Operating Tier and Release Volume tables.
Year1 <- "2023-01-01"           #1st Yr Powell/MSCP tables. Code calculates Year2 (1st yr Mead tables).
date <- Sys.Date()              #Use Sys.Date() when current date is in the same month as the ESP run. Replace with as.Date("YYYY-MM-DD") to specify a month different than current date.

set_flextable_defaults(fonts_ignore=TRUE, font.size = 12, font.family = "Times New Roman", digits = 0, padding.top = 1, padding.bottom = 1, padding.left = 7, padding.right =7)
```


```{r functions and initial calcs, echo=FALSE, results='hide', message=FALSE, warning=FALSE}

#Functions: PT calculates Percent Traces equal to (==) a specified flag or specified elevation z. PT2 calculates Percent Traces <= z. PT3 calculates Percent Traces < z, and PT4 calculates Percent Traces > z. Diff calculates and formats the difference in current and previous month values. Time_Calc adds years to specified dates as characters. TabFormat formats data tables.
PT <- function(x, y, z){round(sum(x[y, Traces]==z)/30*100, digits = 0)} 
PT2 <- function(x, y, z){round(sum(x[y, Traces]<=z)/30*100, digits = 0)}
PT3 <- function(x, y, z){round(sum(x[y, Traces]<z)/30*100, digits = 0)}
PT4 <- function(x, y, z){round(sum(x[y, Traces]>z)/30*100, digits = 0)}
Diff <- function(x, y){if(x - y ==0){x - y} else{sprintf("%+1.0f", x - y)}}
Time_Calc <- function(x, y){as.character(as.Date(x) %m+% years(y))}
Year_format <- function(x){as.numeric(format(as.Date(x), '%Y'))}
TabFormat <- function(t, f){
  f <- flextable(t %>% rownames_to_column(" "))
  f <- align(f, align = "center", part = "all")
  f <- bold(f, part = "header")
  f <- bold(f, j = 1, part = "body")
  f %>% autofit()}

#Time calculations
Current_month <- format(date, '%B %Y') 
Current_month_rn <- format(date, '%B')
Current_month_abbr <- toupper(format(date, '%b%y'))
Previous_month <- format(date %m-% months(1), '%B %Y')
Previous_month_rn <- format(date %m-% months(1), '%B')
EOCY_range <- as.numeric(format(as.Date(EOCY), '%Y'))
EOCY_format <- as.character(as.Date(EOCY) %m-% months(11))
PowellOT_WY <- as.numeric(format(as.Date(PowellOT_WYrn), '%Y'))
Year2 <- Time_Calc(Year1, 1) 
Year3 <- Time_Calc(Year1, 2)
Year4 <- Time_Calc(Year1, 3)  
Year5 <- Time_Calc(Year1, 4)
Year2_Det <- as.character(as.Date(Year2) %m-% months(1))
Year3_Det <- Time_Calc(Year2_Det, 1) 
Year4_Det <- Time_Calc(Year2_Det, 2)
Year5_Det <- Time_Calc(Year2_Det, 3)
EOCYear1 <- as.character(as.Date(Year1) %m+% months(11) %m+% days(30))
EOCYear2 <- as.character(as.Date(Year2) %m+% months(11) %m+% days(30))
Current_WY <- as.numeric(format(as.Date(Year1), '%Y'))
Next_WY <- as.numeric(format(as.Date(Year2), '%Y'))
Third_WY <- as.numeric(format(as.Date(Year3), '%Y'))

PowellUnregInf_Avg <- 9603.36   #Update average, 90th percentile, and 10th percentile when needed
Powell90th <- 14466.59
Powell10th <- 4900.16

Traces <- c("Trace4", "Trace5", "Trace6", "Trace7", "Trace8", "Trace9", "Trace10", 
            "Trace11", "Trace12", "Trace13", "Trace14", "Trace15", "Trace16", "Trace17", 
            "Trace18", "Trace19", "Trace20", "Trace21", "Trace22", "Trace23", "Trace24", 
            "Trace25", "Trace26", "Trace27", "Trace28", "Trace29", "Trace30", "Trace31", 
            "Trace32", "Trace33")

Years <- as.data.frame(list("Trace4" = 1991, "Trace5" = 1992, "Trace6" = 1993, "Trace7" = 1994, 
                            "Trace8" = 1995, "Trace9" = 1996, "Trace10" = 1997, "Trace11" = 1998, 
                            "Trace12" = 1999, "Trace13" = 2000, "Trace14" = 2001, "Trace15" = 2002, 
                            "Trace16" = 2003, "Trace17" = 2004, "Trace18" = 2005, "Trace19" = 2006, 
                            "Trace20" = 2007, "Trace21" = 2008, "Trace22" = 2009, "Trace23" = 2010, 
                            "Trace24" = 2011, "Trace25" = 2012, "Trace26" = 2013, "Trace27" = 2014, 
                            "Trace28" = 2015, "Trace29" = 2016, "Trace30" = 2017, "Trace31" = 2018, 
                            "Trace32" = 2019, "Trace33" = 2020))

#Min/Max elevations code for summary points

Powell_Elev <- as.data.frame(read_excel("EnsembleOutput.xlsx", sheet = "Powell.Pool Elevation"))
rownames(Powell_Elev) <- Powell_Elev[,1]
Powell_min <- round(min(Powell_Elev[EOCY,Traces]), digits =2)
Powell_max <- round(max(Powell_Elev[EOCY,Traces]), digits =2)

# Powell_Elev_eff <- as.data.frame(read_excel("EnsembleOutput.xlsx", sheet = "PowellElev"))
# rownames(Powell_Elev_eff) <- Powell_Elev_eff[,1]
# Powell_Eff <- as.data.frame(sapply(Powell_Elev_eff[EOCY_format, Traces],as.numeric))
# Powell_min_eff <- round(min(Powell_Eff), digits =2)
# Powell_max_eff <- round(max(Powell_Eff), digits =2)

Mead_Elev <- as.data.frame(read_excel("EnsembleOutput.xlsx", sheet = "Mead.Pool Elevation"))
rownames(Mead_Elev) <- Mead_Elev[,1]
Mead_min <- round(min(Mead_Elev[EOCY,Traces]), digits =2)
Mead_max <- round(max(Mead_Elev[EOCY,Traces]), digits =2)

# Mead_Elev_eff <- as.data.frame(read_excel("EnsembleOutput.xlsx", sheet = "MeadElev"))
# rownames(Mead_Elev_eff) <- Mead_Elev_eff[,1]
# Mead_Eff <- as.data.frame(sapply(Mead_Elev_eff[EOCY_format, Traces],as.numeric))
# Mead_min_eff <- round(min(Mead_Eff), digits =2)
# Mead_max_eff <- round(max(Mead_Eff), digits =2)
```
The `r Current_month` CRMMS ESP results are attached and summarized below:

* Projected Elevations:
  * Lake Powell EOCY `r EOCY_range` range: `r Powell_min` feet – `r Powell_max` feet
  * Lake Mead EOCY `r EOCY_range` range: `r Mead_min` feet – `r Mead_max` feet

**Changes from `r Previous_month` Run** 

```{r code for table data, echo=FALSE, results='hide', message=FALSE, warning=FALSE}

#Percent of Traces per Powell Operating Tier Data

PowellOT <- as.data.frame(read_excel("EnsembleOutput.xlsx", sheet = "PowellData.ReleaseTier"))
rownames(PowellOT) <- PowellOT[,1]
PowellRel <- as.data.frame(read_excel("EnsembleOutput.xlsx", sheet = "UpperBalancingAt823"))
rownames(PowellRel) <- PowellRel[,1]
PowellBelow <- as.data.frame(read_excel("EnsembleOutput.xlsx", sheet = "UpperBalancingBelow823"))
rownames(PowellRel) <- PowellRel[,1]
PowellAbove <- as.data.frame(read_excel("EnsembleOutput.xlsx", sheet = "UpperBalancingAbove823"))
rownames(PowellRel) <- PowellRel[,1]
PowellOT_LM <- as.data.frame(read_excel(Last_month_file, sheet = "PowellData.ReleaseTier"))
rownames(PowellOT_LM) <- PowellOT_LM[,1]
PowellRel_LM <- as.data.frame(read_excel(Last_month_file, sheet = "UpperBalancingAt823"))
rownames(PowellRel_LM) <- PowellRel_LM[,1]
PowellBelow_LM <- as.data.frame(read_excel(Last_month_file, sheet = "UpperBalancingBelow823"))
rownames(PowellRel_LM) <- PowellRel_LM[,1]
PowellAbove_LM <- as.data.frame(read_excel(Last_month_file, sheet = "UpperBalancingAbove823"))
rownames(PowellRel_LM) <- PowellRel_LM[,1]

Eq <- c(PT(PowellOT, PowellOT_WYrn, 0), PT(PowellOT_LM, PowellOT_WYrn, 0), Diff(PT(PowellOT, PowellOT_WYrn, 0), PT(PowellOT_LM, PowellOT_WYrn, 0)))
UEBT823 <- c(PT(PowellRel, PowellOT_WYrn, 1), PT(PowellRel_LM, PowellOT_WYrn, 1), Diff(PT(PowellRel, PowellOT_WYrn, 1), PT(PowellRel_LM, PowellOT_WYrn, 1)))
UEBT <- c(PT(PowellOT, PowellOT_WYrn, 1), PT(PowellOT_LM, PowellOT_WYrn, 1), Diff(PT(PowellOT, PowellOT_WYrn, 1), PT(PowellOT_LM, PowellOT_WYrn, 1)))
UEBTB823 <- c(PT(PowellRel, PowellOT_WYrn, 1), PT(PowellRel_LM, PowellOT_WYrn, 1), Diff(PT(PowellRel, PowellOT_WYrn, 1), PT(PowellRel_LM, PowellOT_WYrn, 1)))
MERT <- c(PT(PowellOT, PowellOT_WYrn, 2), PT(PowellOT_LM, PowellOT_WYrn, 2), Diff(PT(PowellOT, PowellOT_WYrn, 2), PT(PowellOT_LM, PowellOT_WYrn, 2)))
LEBT <- c(PT(PowellOT, PowellOT_WYrn, 3), PT(PowellOT_LM, PowellOT_WYrn, 3), Diff(PT(PowellOT, PowellOT_WYrn, 3), PT(PowellOT_LM, PowellOT_WYrn, 3)))

tab_PowellOT <- data.frame(Eq, UEBT823, UEBT, UEBTB823, MERT, LEBT)
row.names(tab_PowellOT) <- c(Current_month_rn,Previous_month_rn,"Difference")
names(tab_PowellOT) <- c("Eq.", "UEBT>8.23", "UEBT=8.23", "UEBT<8.23","MERT", "LEBT")

#Percent of Traces in Powell Annual Release Volume Scenario

PowellRV <- as.data.frame(read_excel("EnsembleOutput.xlsx", sheet = "PowellTargetAnnualReleaseVolume"))
rownames(PowellRV) <- PowellRV[,1]
PowellRV_LM <- as.data.frame(read_excel(Last_month_file, sheet = "PowellTargetAnnualReleaseVolume"))
rownames(PowellRV_LM) <- PowellRV_LM[,1]

PT_PowellRel <- function(x,y){round(sum(round(x[y, Traces])==8230)/30*100, digits = 0)}
PT3_PowellRel <- function(x,y){round(sum(round(x[y, Traces])<8230)/30*100, digits = 0)}
PT4_PowellRel <- function(x,y,z){round(sum(round(x[y, Traces])>8230)/30*100, digits = 0)}

L823_Y2 <- c(PT3_PowellRel(PowellRV, PowellOT_WYrn), PT3_PowellRel(PowellRV_LM, PowellOT_WYrn), Diff(PT3_PowellRel(PowellRV, PowellOT_WYrn), PT3_PowellRel(PowellRV_LM, PowellOT_WYrn)))
E823_Y2 <- c(PT_PowellRel(PowellRV, PowellOT_WYrn), PT_PowellRel(PowellRV_LM, PowellOT_WYrn), Diff(PT_PowellRel(PowellRV, PowellOT_WYrn), PT_PowellRel(PowellRV_LM, PowellOT_WYrn)))
G823_Y2 <- c(PT4_PowellRel(PowellRV, PowellOT_WYrn), PT4_PowellRel(PowellRV_LM, PowellOT_WYrn), Diff(PT4_PowellRel(PowellRV, PowellOT_WYrn), PT4_PowellRel(PowellRV_LM, PowellOT_WYrn)))

L823_Y3 <- c(PT3_PowellRel(PowellRV, Time_Calc(PowellOT_WYrn, 1)), PT3_PowellRel(PowellRV_LM, Time_Calc(PowellOT_WYrn, 1)), Diff(PT3_PowellRel(PowellRV, Time_Calc(PowellOT_WYrn, 1)), PT3_PowellRel(PowellRV_LM, Time_Calc(PowellOT_WYrn, 1))))
E823_Y3 <- c(PT_PowellRel(PowellRV, Time_Calc(PowellOT_WYrn, 1)), PT_PowellRel(PowellRV_LM, Time_Calc(PowellOT_WYrn, 1)), Diff(PT_PowellRel(PowellRV, Time_Calc(PowellOT_WYrn, 1)), PT_PowellRel(PowellRV_LM, Time_Calc(PowellOT_WYrn, 1))))
G823_Y3 <- c(PT4_PowellRel(PowellRV, Time_Calc(PowellOT_WYrn, 1)), PT4_PowellRel(PowellRV_LM, Time_Calc(PowellOT_WYrn, 1)), Diff(PT4_PowellRel(PowellRV, Time_Calc(PowellOT_WYrn, 1)), PT4_PowellRel(PowellRV_LM, Time_Calc(PowellOT_WYrn, 1))))

L823_Y4 <- c(PT3_PowellRel(PowellRV, Time_Calc(PowellOT_WYrn, 2)), PT3_PowellRel(PowellRV_LM, Time_Calc(PowellOT_WYrn, 2)), Diff(PT3_PowellRel(PowellRV, Time_Calc(PowellOT_WYrn, 2)), PT3_PowellRel(PowellRV_LM, Time_Calc(PowellOT_WYrn, 2))))
E823_Y4 <- c(PT_PowellRel(PowellRV, Time_Calc(PowellOT_WYrn, 2)), PT_PowellRel(PowellRV_LM, Time_Calc(PowellOT_WYrn, 2)), Diff(PT_PowellRel(PowellRV, Time_Calc(PowellOT_WYrn, 2)), PT_PowellRel(PowellRV_LM, Time_Calc(PowellOT_WYrn, 2))))
G823_Y4 <- c(PT4_PowellRel(PowellRV, Time_Calc(PowellOT_WYrn, 2)), PT4_PowellRel(PowellRV_LM, Time_Calc(PowellOT_WYrn, 2)), Diff(PT4_PowellRel(PowellRV, Time_Calc(PowellOT_WYrn, 2)), PT4_PowellRel(PowellRV_LM, Time_Calc(PowellOT_WYrn, 2))))

tab_PowellRV <- data.frame(L823_Y2, E823_Y2, G823_Y2, L823_Y3, E823_Y3, G823_Y3, L823_Y4, E823_Y4, G823_Y4)
row.names(tab_PowellRV) <- c(Current_month_rn,Previous_month_rn,"Difference")

#Percent of Traces with Powell Physical Elevation < Upper Basin DCP Trigger Elev of 3,525 in any month

Powell3525 <- as.data.frame(read_excel("EnsembleOutput.xlsx", sheet = "Powell3525Annual"))
rownames(Powell3525) <- Powell3525[,1]
Powell3525_LM <- as.data.frame(read_excel(Last_month_file, sheet = "Powell3525Annual"))
rownames(Powell3525_LM) <- Powell3525_LM[,1]

Powell3525_1 <- c(PT(Powell3525, Year1, 1), PT(Powell3525_LM, Year1, 1), Diff(PT(Powell3525, Year1, 1), PT(Powell3525_LM, Year1, 1)))
Powell3525_2 <- c(PT(Powell3525, Year2, 1), PT(Powell3525_LM, Year2, 1), Diff(PT(Powell3525, Year2, 1), PT(Powell3525_LM, Year2, 1)))
Powell3525_3 <- c(PT(Powell3525, Year3, 1), PT(Powell3525_LM, Year3, 1), Diff(PT(Powell3525, Year3, 1), PT(Powell3525_LM, Year3, 1)))
Powell3525_4 <- c(PT(Powell3525, Year4, 1), PT(Powell3525_LM, Year4, 1), Diff(PT(Powell3525, Year4, 1), PT(Powell3525_LM, Year4, 1)))
Powell3525_5 <- c(PT(Powell3525, Year5, 1), PT(Powell3525_LM, Year5, 1), Diff(PT(Powell3525, Year5, 1), PT(Powell3525_LM, Year5, 1)))
tab_Powell3525 <- data.frame(Powell3525_1, Powell3525_2, Powell3525_3, Powell3525_4, Powell3525_5)
row.names(tab_Powell3525) <- c(Current_month_rn,Previous_month_rn,"Difference")
names(tab_Powell3525) <- c(Year_format(Year1), Year_format(Year2), Year_format(Year3), Year_format(Year4), Year_format(Year5))

#Percent of Traces with Powell Physical Elevation below Min Power Pool in any month

Powell3490 <- as.data.frame(read_excel("EnsembleOutput.xlsx", sheet = "Powell3490Annual"))
rownames(Powell3490) <- Powell3490[,1]
Powell3490_LM <- as.data.frame(read_excel(Last_month_file, sheet = "Powell3490Annual"))
rownames(Powell3490_LM) <- Powell3490_LM[,1]

Powell3490_1 <- c(PT(Powell3490, Year1, 1), PT(Powell3490_LM, Year1, 1), Diff(PT(Powell3490, Year1, 1), PT(Powell3490_LM, Year1, 1)))
Powell3490_2 <- c(PT(Powell3490, Year2, 1), PT(Powell3490_LM, Year2, 1), Diff(PT(Powell3490, Year2, 1), PT(Powell3490_LM, Year2, 1)))
Powell3490_3 <- c(PT(Powell3490, Year3, 1), PT(Powell3490_LM, Year3, 1), Diff(PT(Powell3490, Year3, 1), PT(Powell3490_LM, Year3, 1)))
Powell3490_4 <- c(PT(Powell3490, Year4, 1), PT(Powell3490_LM, Year4, 1), Diff(PT(Powell3490, Year4, 1), PT(Powell3490_LM, Year4, 1)))
Powell3490_5 <- c(PT(Powell3490, Year5, 1), PT(Powell3490_LM, Year5, 1), Diff(PT(Powell3490, Year5, 1), PT(Powell3490_LM, Year5, 1)))
tab_Powell3490 <- data.frame(Powell3490_1, Powell3490_2, Powell3490_3, Powell3490_4, Powell3490_5)
row.names(tab_Powell3490) <- c(Current_month_rn,Previous_month_rn,"Difference")
names(tab_Powell3490) <- c(Year_format(Year1), Year_format(Year2), Year_format(Year3), Year_format(Year4), Year_format(Year5))

#Percent of Traces with Lower Basin DCP (<= 1,090 on Jan 1)

LBDCP <- as.data.frame(read_excel("EnsembleOutput.xlsx", sheet = "DCPBWSP_Type"))
rownames(LBDCP) <- LBDCP[,1]
LBDCP_LM <- as.data.frame(read_excel(Last_month_file, sheet = "DCPBWSP_Type"))
rownames(LBDCP_LM) <- LBDCP_LM[,1]
LBDCP_2 <- c(PT2(LBDCP,Year2,7), PT2(LBDCP_LM,Year2,7), Diff(PT2(LBDCP,Year2,7), PT2(LBDCP_LM,Year2,7)))
LBDCP_3 <- c(PT2(LBDCP,Year3,7), PT2(LBDCP_LM,Year3,7), Diff(PT2(LBDCP,Year3,7), PT2(LBDCP_LM,Year3,7)))
LBDCP_4 <- c(PT2(LBDCP,Year4,7), PT2(LBDCP_LM,Year4,7), Diff(PT2(LBDCP,Year4,7), PT2(LBDCP_LM,Year4,7)))
LBDCP_5 <- c(PT2(LBDCP,Year5,7), PT2(LBDCP_LM,Year5,7), Diff(PT2(LBDCP,Year5,7), PT2(LBDCP_LM,Year5,7)))
tab_LBDCP <- data.frame(LBDCP_2, LBDCP_3, LBDCP_4, LBDCP_5)
row.names(tab_LBDCP) <- c(Current_month_rn,Previous_month_rn,"Difference")
names(tab_LBDCP) <- c(Year_format(Year2), Year_format(Year3), Year_format(Year4), Year_format(Year5))

#Percent of Traces with Lower Basin Shortage - Any condition (<= 1,075 on Jan 1)

Mead1075 <- as.data.frame(read_excel("EnsembleOutput.xlsx", sheet = "AnnualShortageAnyTypeFlag"))
rownames(Mead1075) <- Mead1075[,1]
Mead1075_LM <- as.data.frame(read_excel(Last_month_file, sheet = "AnnualShortageAnyTypeFlag"))
rownames(Mead1075_LM) <- Mead1075_LM[,1]
Mead1075_2 <- c(PT(Mead1075, Year2, 1), PT(Mead1075_LM, Year2, 1), Diff(PT(Mead1075, Year2, 1), PT(Mead1075_LM, Year2, 1)))
Mead1075_3 <- c(PT(Mead1075, Year3, 1), PT(Mead1075_LM, Year3, 1), Diff(PT(Mead1075, Year3, 1), PT(Mead1075_LM, Year3, 1)))
Mead1075_4 <- c(PT(Mead1075, Year4, 1), PT(Mead1075_LM, Year4, 1), Diff(PT(Mead1075, Year4, 1), PT(Mead1075_LM, Year4, 1)))
Mead1075_5 <- c(PT(Mead1075, Year5, 1), PT(Mead1075_LM, Year5, 1), Diff(PT(Mead1075, Year5, 1), PT(Mead1075_LM, Year5, 1)))
tab_Mead1075 <- data.frame(Mead1075_2, Mead1075_3, Mead1075_4, Mead1075_5)
row.names(tab_Mead1075) <- c(Current_month_rn,Previous_month_rn,"Difference")
names(tab_Mead1075) <- c(Year_format(Year2), Year_format(Year3), Year_format(Year4), Year_format(Year5))

#Percent of Traces with Lower Basin Shortage (<= 1,050 on Jan 1)

Mead1050 <- as.data.frame(read_excel("EnsembleOutput.xlsx", sheet = "DCPBWSP_Type"))
rownames(Mead1050) <- Mead1050[,1]
Mead1050_LM <- as.data.frame(read_excel(Last_month_file, sheet = "DCPBWSP_Type"))
rownames(Mead1050_LM) <- Mead1050_LM[,1]
Mead1050_2 <- c(PT2(Mead1050, Year2, 5), PT2(Mead1050_LM, Year2, 5), Diff(PT2(Mead1050, Year2, 5), PT2(Mead1050_LM, Year2, 5)))
Mead1050_3 <- c(PT2(Mead1050, Year3, 5), PT2(Mead1050_LM, Year3, 5), Diff(PT2(Mead1050, Year3, 5), PT2(Mead1050_LM, Year3, 5)))
Mead1050_4 <- c(PT2(Mead1050, Year4, 5), PT2(Mead1050_LM, Year4, 5), Diff(PT2(Mead1050, Year4, 5), PT2(Mead1050_LM, Year4, 5)))
Mead1050_5 <- c(PT2(Mead1050, Year5, 5), PT2(Mead1050_LM, Year5, 5), Diff(PT2(Mead1050, Year5, 5), PT2(Mead1050_LM, Year5, 5)))
tab_Mead1050 <- data.frame(Mead1050_2, Mead1050_3, Mead1050_4, Mead1050_5)
row.names(tab_Mead1050) <- c(Current_month_rn,Previous_month_rn,"Difference")
names(tab_Mead1050) <- c(Year_format(Year2), Year_format(Year3), Year_format(Year4), Year_format(Year5))

#Percent of Traces with Lower Basin Shortage (<= 1,045 on Jan 1)

Mead1045 <- as.data.frame(read_excel("EnsembleOutput.xlsx", sheet = "DCPBWSP_Type"))
rownames(Mead1045) <- Mead1045[,1]
Mead1045_LM <- as.data.frame(read_excel(Last_month_file, sheet = "DCPBWSP_Type"))
rownames(Mead1045_LM) <- Mead1045_LM[,1]
Mead1045_2 <- c(PT2(Mead1045, Year2, 4), PT2(Mead1045_LM, Year2, 4), Diff(PT2(Mead1045, Year2, 4), PT2(Mead1045_LM, Year2, 4)))
Mead1045_3 <- c(PT2(Mead1045, Year3, 4), PT2(Mead1045_LM, Year3, 4), Diff(PT2(Mead1045, Year3, 4), PT2(Mead1045_LM, Year3, 4)))
Mead1045_4 <- c(PT2(Mead1045, Year4, 4), PT2(Mead1045_LM, Year4, 4), Diff(PT2(Mead1045, Year4, 4), PT2(Mead1045_LM, Year4, 4)))
Mead1045_5 <- c(PT2(Mead1045, Year5, 4), PT2(Mead1045_LM, Year5, 4), Diff(PT2(Mead1045, Year5, 4), PT2(Mead1045_LM, Year5, 4)))
tab_Mead1045 <- data.frame(Mead1045_2, Mead1045_3, Mead1045_4, Mead1045_5)
row.names(tab_Mead1045) <- c(Current_month_rn,Previous_month_rn,"Difference")
names(tab_Mead1045) <- c(Year_format(Year2), Year_format(Year3), Year_format(Year4), Year_format(Year5))

#Percent of Traces with Lower Basin Shortage (<= 1,025 on Jan 1)

Mead1025 <- as.data.frame(read_excel("EnsembleOutput.xlsx", sheet = "DCPBWSP_Type"))
rownames(Mead1025) <- Mead1025[,1]
Mead1025_LM <- as.data.frame(read_excel(Last_month_file, sheet = "DCPBWSP_Type"))
rownames(Mead1025_LM) <- Mead1025_LM[,1]
Mead1025_2 <- c(PT2(Mead1025, Year2, 0), PT2(Mead1025_LM, Year2, 0), Diff(PT2(Mead1025, Year2, 0), PT2(Mead1025_LM, Year2, 0)))
Mead1025_3 <- c(PT2(Mead1025, Year3, 0), PT2(Mead1025_LM, Year3, 0), Diff(PT2(Mead1025, Year3, 0), PT2(Mead1025_LM, Year3, 0)))
Mead1025_4 <- c(PT2(Mead1025, Year4, 0), PT2(Mead1025_LM, Year4, 0), Diff(PT2(Mead1025, Year4, 0), PT2(Mead1025_LM, Year4, 0)))
Mead1025_5 <- c(PT2(Mead1025, Year5, 0), PT2(Mead1025_LM, Year5, 0), Diff(PT2(Mead1025, Year5, 0), PT2(Mead1025_LM, Year5, 0)))
tab_Mead1025 <- data.frame(Mead1025_2, Mead1025_3, Mead1025_4, Mead1025_5)
row.names(tab_Mead1025) <- c(Current_month_rn,Previous_month_rn,"Difference")
names(tab_Mead1025) <- c(Year_format(Year2), Year_format(Year3), Year_format(Year4), Year_format(Year5))

#Percent of Traces with Lake Mead <= 950 any month

Mead950 <- as.data.frame(read_excel("EnsembleOutput.xlsx", sheet = "MeadData.MeadBelow950_Annual"))
rownames(Mead950) <- Mead950[,1]
Mead950_LM <- as.data.frame(read_excel(Last_month_file, sheet = "MeadData.MeadBelow950_Annual"))
rownames(Mead950_LM) <- Mead950_LM[,1]
Mead950_2 <- c(PT(Mead950, Year2, 1), PT(Mead950_LM, Year2, 1), Diff(PT(Mead950, Year2, 1), PT(Mead950_LM, Year2, 1)))
Mead950_3 <- c(PT(Mead950, Year3, 1), PT(Mead950_LM, Year3, 1), Diff(PT(Mead950, Year3, 1), PT(Mead950_LM, Year3, 1)))
Mead950_4 <- c(PT(Mead950, Year4, 1), PT(Mead950_LM, Year4, 1), Diff(PT(Mead950, Year4, 1), PT(Mead950_LM, Year4, 1)))
Mead950_5 <- c(PT(Mead950, Year5, 1), PT(Mead950_LM, Year5, 1), Diff(PT(Mead950, Year5, 1), PT(Mead950_LM, Year5, 1)))
tab_Mead950 <- data.frame(Mead950_2, Mead950_3, Mead950_4, Mead950_5)
row.names(tab_Mead950) <- c(Current_month_rn,Previous_month_rn,"Difference")
names(tab_Mead950) <- c(Year_format(Year2), Year_format(Year3), Year_format(Year4), Year_format(Year5))

#Percent of Traces with Lake Mead <= 895 any month

Mead895 <- as.data.frame(read_excel("EnsembleOutput.xlsx", sheet = "MeadData.MeadBelow895_Annual"))
rownames(Mead895) <- Mead895[,1]
Mead895_LM <- as.data.frame(read_excel(Last_month_file, sheet = "MeadData.MeadBelow895_Annual"))
rownames(Mead895_LM) <- Mead895_LM[,1]
Mead895_2 <- c(PT(Mead895, Year2, 1), PT(Mead895_LM, Year2, 1), Diff(PT(Mead895, Year2, 1), PT(Mead895_LM, Year2, 1)))
Mead895_3 <- c(PT(Mead895, Year3, 1), PT(Mead895_LM, Year3, 1), Diff(PT(Mead895, Year3, 1), PT(Mead895_LM, Year3, 1)))
Mead895_4 <- c(PT(Mead895, Year4, 1), PT(Mead895_LM, Year4, 1), Diff(PT(Mead895, Year4, 1), PT(Mead895_LM, Year4, 1)))
Mead895_5 <- c(PT(Mead895, Year5, 1), PT(Mead895_LM, Year5, 1), Diff(PT(Mead895, Year5, 1), PT(Mead895_LM, Year5, 1)))
tab_Mead895 <- data.frame(Mead895_2, Mead895_3, Mead895_4, Mead895_5)
row.names(tab_Mead895) <- c(Current_month_rn,Previous_month_rn,"Difference")
names(tab_Mead895) <- c(Year_format(Year2), Year_format(Year3), Year_format(Year4), Year_format(Year5))

# #Percent of Traces with MSCP Violation
# 
# MSCP <- as.data.frame(read_excel("EnsembleOutput.xlsx", sheet = "MeadData.MSCPViolation"))
# rownames(MSCP) <- MSCP[,1]
# MSCP_LM <- as.data.frame(read_excel(Last_month_file, sheet = "MeadData.MSCPViolation"))
# rownames(MSCP_LM) <- MSCP_LM[,1]
# MSCP1 <- c(PT(MSCP,Year1,1), PT(MSCP_LM,Year1,1), Diff(PT(MSCP,Year1,1), PT(MSCP_LM,Year1,1)))
# MSCP2 <- c(PT(MSCP,Year2,1), PT(MSCP_LM,Year2,1), Diff(PT(MSCP,Year2,1), PT(MSCP_LM,Year2,1)))
# MSCP3 <- c(PT(MSCP,Year3,1), PT(MSCP_LM,Year3,1), Diff(PT(MSCP,Year3,1), PT(MSCP_LM,Year3,1)))
# MSCP4 <- c(PT(MSCP,Year4,1), PT(MSCP_LM,Year4,1), Diff(PT(MSCP,Year4,1), PT(MSCP_LM,Year4,1)))
# MSCP5 <- c(PT(MSCP,Year5,1), PT(MSCP_LM,Year5,1), Diff(PT(MSCP,Year5,1), PT(MSCP_LM,Year5,1)))
# tab_MSCP <- data.frame(MSCP1, MSCP2, MSCP3, MSCP4, MSCP5)
# row.names(tab_MSCP) <- c(Current_month_rn,Previous_month_rn,"Difference")
# names(tab_MSCP) <- c(Year_format(Year1), Year_format(Year2), Year_format(Year3), Year_format(Year4), Year_format(Year5))
```

% of Traces per Powell Operating Tier in WY `r PowellOT_WY`:
```{r ft.align="left", echo=FALSE}
TabFormat(tab_PowellOT)
```

* ADD BULLETS OF NOTE HERE
<br>

% Traces in Powell Annual Release Volume Scenario:
```{r ft.align="left", echo=FALSE}

ft_PowellRV <- flextable(tab_PowellRV %>% rownames_to_column(" "))
ft_PowellRV <- set_header_labels(ft_PowellRV, L823_Y2 = "<8.23", E823_Y2 = "8.23", G823_Y2 = ">8.23", L823_Y3 = "<8.23", E823_Y3 = "8.23", G823_Y3 = ">8.23", L823_Y4 = "<8.23", E823_Y4 = "8.23", G823_Y4 = ">8.23")
ft_PowellRV <- add_header_row(ft_PowellRV, values = c(" ", PowellOT_WY, PowellOT_WY + 1, PowellOT_WY + 2), colwidths = c(1, 3, 3, 3))
ft_PowellRV <- vline(ft_PowellRV, j = 4)
ft_PowellRV <- vline(ft_PowellRV, j = 7)
ft_PowellRV <- align(ft_PowellRV, align = "center", part = "all")
#ft_PowellRV <- align_text_col(ft_PowellRV, align = "left")
ft_PowellRV <- bold(ft_PowellRV, part = "header")
ft_PowellRV <- bold(ft_PowellRV, j = 1, part = "body")
ft_PowellRV <- padding(ft_PowellRV, padding.left = 3, padding.right = 3, part = "all")
ft_PowellRV %>% autofit()
```
<br>
% Traces with Powell Elevation below the Upper Basin DCP Trigger elevation of 3,525 ft in any month during the CY:
```{r ft.align="left", echo=FALSE}
TabFormat(tab_Powell3525)
```
\newpage
% Traces with Powell Elevation below Minimum Power Pool in any month during the CY:
```{r ft.align="left", echo=FALSE}
TabFormat(tab_Powell3490)
```
* ADD BULLETS OF NOTE HERE

% Traces with Lower Basin DCP (Lake Mead Elevation <= 1,090 ft on January 1):
```{r ft.align="left", echo=FALSE}
 TabFormat(tab_LBDCP)
```

% Traces with Lower Basin Shortage - Any Condition (Lake Mead Elevation <= 1,075 ft on January 1):
```{r ft.align="left", echo=FALSE}
TabFormat(tab_Mead1075)
```

% Traces with Lower Basin Shortage (Lake Mead Elevation <= 1,050 ft on January 1):
```{r ft.align="left", echo=FALSE}
TabFormat(tab_Mead1050)
```

% Traces with Lower Basin Shortage (Lake Mead Elevation <= 1,045 ft on January 1):
```{r ft.align="left", echo=FALSE}
TabFormat(tab_Mead1045)
```
\newpage
% Traces with Lower Basin Shortage (Lake Mead Elevation <= 1,025 ft on January 1):
```{r ft.align="left", echo=FALSE}
TabFormat(tab_Mead1025)
```

% Traces with Lake Mead Elevation <= 950 ft in any month:
```{r ft.align="left", echo=FALSE}
TabFormat(tab_Mead950)
```

% Traces with Lake Mead Elevation <= 895 ft in any month:
```{r ft.align="left", echo=FALSE}
TabFormat(tab_Mead895)
```


```{r figures, fig.width=10, fig.height=6, fig.fullwidth=TRUE, echo=FALSE, results='hide', message=FALSE, warning=FALSE}

#Annual Powell Inflow Analysis

PowellUnregInf <- as.data.frame(read_excel("EnsembleOutput.xlsx", sheet = "PowellAJUnregInflow"))
rownames(PowellUnregInf) <- PowellUnregInf[,1]
PowellRT <- as.data.frame(read_excel("EnsembleOutput.xlsx", sheet = "PowellData.ReleaseTier"))
rownames(PowellRT) <- PowellRT[,1]
PowellRT_df <- data.frame(Trace_Years = as.character(t(Years)), Powell_UnregInf = as.numeric(PowellUnregInf[EOCYear1,Traces]), Rel_Tier = as.numeric(PowellRT[Year2,Traces]))
PowellRT_df_NextWY <- data.frame(Trace_Years = as.character(t(Years)), Powell_UnregInf = as.numeric(PowellUnregInf[EOCYear2,Traces]), Rel_Tier = as.numeric(PowellRT[Year3,Traces]))

Operating_Tier <- character()
for(i in 1:30){
  if(PowellRT_df[i, 3]==0){
    x = "Eq"
  } else if(PowellRT_df[i, 3]==3){
    x = "LEBT"
  } else if(PowellRT_df[i, 3]==2){
    x = "MERT"
  } else if(PowellRT_df[i, 3]==1){
    x = "UEBT"
  }
  Operating_Tier <- c(Operating_Tier, x)
}

Operating_Tier_NextWY <- character()
for(i in 1:30){
  if(PowellRT_df_NextWY[i, 3]==0){
    x = "Eq"
  } else if(PowellRT_df_NextWY[i, 3]==3){
    x = "LEBT"
  } else if(PowellRT_df_NextWY[i, 3]==2){
    x = "MERT"
  } else if(PowellRT_df_NextWY[i, 3]==1){
    x = "UEBT"
  }
  Operating_Tier_NextWY <- c(Operating_Tier_NextWY, x)
}

Tier_colors <- c("#CC6666", "#E69F00", "#33CC33", "#0072B2")
names(Tier_colors) <- c("LEBT", "MERT", "UEBT", "Eq")
manual_scale <- scale_fill_manual(name = paste("WY", Next_WY, "Operating Tier"), values = Tier_colors)
manual_scale_NextWY <- scale_fill_manual(name = paste("WY", Third_WY, "Operating Tier"), values = Tier_colors)

ggplot(PowellRT_df, aes(fct_reorder(PowellRT_df[,"Trace_Years"], Powell_UnregInf), Powell_UnregInf)) + geom_bar(stat="identity", aes(fill = Operating_Tier)) + manual_scale + labs(x = "Hydrologic Trace", y = "Powell Unregulated Inflow (1,000 AF)") + theme(axis.text.x=element_text(angle = 90)) + geom_hline(yintercept = c(Powell90th, Powell10th), linetype = 'dashed') + geom_hline(yintercept = PowellUnregInf_Avg, color = 'darkred') + geom_text(aes(0, Powell10th, label = "Historic 10th Percentile"), vjust = -0.5, hjust = "left") + geom_text(aes(0, Powell90th, label = "Historic 90th Percentile"), vjust = -0.5, hjust = "left") + geom_text(aes(0, PowellUnregInf_Avg, label = "Historic Average"), vjust = -0.5, hjust = "left") + ggtitle(paste("Annual Powell Inflow Analysis based on WY", Current_WY, "Inflow Volumes")) + theme(axis.text = element_text(size = 12), axis.title = element_text(size = 14), plot.title = element_text(size = 16), legend.text = element_text(size = 12), legend.title = element_text(size = 12))

ggplot(PowellRT_df_NextWY, aes(fct_reorder(PowellRT_df[,"Trace_Years"], Powell_UnregInf), Powell_UnregInf)) + geom_bar(stat="identity", aes(fill = Operating_Tier_NextWY)) + manual_scale_NextWY + labs(x = "Hydrologic Trace", y = "Powell Unregulated Inflow (1,000 AF)") + theme(axis.text.x = element_text(angle = 90)) + geom_hline(yintercept = c(Powell90th, Powell10th), linetype = 'dashed')  + geom_hline(yintercept = PowellUnregInf_Avg, color = 'darkred') + geom_text(aes(0, Powell10th, label = "Historic 10th Percentile"), vjust = -0.5, hjust = "left") + geom_text(aes(0, Powell90th, label = "Historic 90th Percentile"), vjust = -0.5, hjust = "left") + geom_text(aes(0, PowellUnregInf_Avg, label = "Historic Average"), vjust = -0.5, hjust = "left") + ggtitle(paste("Annual Powell Inflow Analysis based on WY", Next_WY, "Inflow Volumes")) + theme(axis.text = element_text(size = 12), axis.title = element_text(size = 14), plot.title = element_text(size = 16), legend.text = element_text(size = 12), legend.title = element_text(size = 12))


#Annual Mead Inflow and Outflow Analysis

Mead_Inflow <- as.data.frame(read_excel("EnsembleOutput.xlsx", sheet = "Mead.Inflow"))
Mead_years <- as.numeric(format(as.Date(Mead_Inflow[,1]), '%Y'))
Mead_Inflow_df <- cbind(Mead_years, Mead_Inflow[-1])
Mead_Inflow_yr <- aggregate(.~Mead_years, data = Mead_Inflow_df, FUN=sum)
rownames(Mead_Inflow_yr) <- Mead_Inflow_yr[,1]

Mead_Outflow <- as.data.frame(read_excel("EnsembleOutput.xlsx", sheet = "Mead.Outflow"))
Mead_years_Outflow <- as.numeric(format(as.Date(Mead_Outflow[,1]), '%Y'))
Mead_Outflow_df <- cbind(Mead_years, Mead_Outflow[-1])
Mead_Outflow_yr <- aggregate(.~Mead_years_Outflow, data = Mead_Outflow_df, FUN=sum)
rownames(Mead_Outflow_yr) <- Mead_Outflow_yr[,1]

LCShortage <- as.data.frame(read_excel("EnsembleOutput.xlsx", sheet = "Shortage.Shortage Flag"))
rownames(LCShortage) <- LCShortage[,1]
LCSurplus <- as.data.frame(read_excel("EnsembleOutput.xlsx", sheet = "Surplus.AnnualSurplusFlag"))
rownames(LCSurplus) <- LCSurplus[,1]

Mead_Inflow_yr_df <- data.frame(Trace_Years = as.character(t(Years)), Inflow = as.numeric(Mead_Inflow_yr[as.character(Next_WY),Traces]), Outflow = as.numeric(Mead_Outflow_yr[as.character(Next_WY),Traces]), ShortageFlag = t(LCShortage[as.character(Next_WY + 1),Traces]), SurplusFlag = t(LCSurplus[as.character(Next_WY + 1),Traces]))
Mead_Inflow_yr2_df <- data.frame(Trace_Years = as.character(t(Years)), Inflow = as.numeric(Mead_Inflow_yr[as.character(Next_WY+1),Traces]), Outflow = as.numeric(Mead_Outflow_yr[as.character(Next_WY+1),Traces]), ShortageFlag = t(LCShortage[as.character(Next_WY + 2),Traces]), SurplusFlag = t(LCSurplus[as.character(Next_WY + 2),Traces]))

Operations <- character()
for(i in 1:30){
  if(Mead_Inflow_yr_df[i, 4]==0 & Mead_Inflow_yr_df[i, 5]==1){
    x = "Surplus"
  } else if(Mead_Inflow_yr_df[i, 4]==0 & Mead_Inflow_yr_df[i, 5]==0){
    x = "Normal"
  } else if(Mead_Inflow_yr_df[i, 4]==1){
    x = "Shortage - Level 1"
  } else if(Mead_Inflow_yr_df[i, 4]==2){
    x = "Shortage - Level 2"
  } else if(Mead_Inflow_yr_df[i, 4]==3){
    x = "Shortage - Level 3"
  }
  Operations <- c(Operations, x)
}

Operations2 <- character()
for(i in 1:30){
  if(Mead_Inflow_yr2_df[i, 4]==0 & Mead_Inflow_yr2_df[i, 5]==1){
    x = "Surplus"
  } else if(Mead_Inflow_yr2_df[i, 4]==0 & Mead_Inflow_yr2_df[i, 5]==0){
    x = "Normal"
  } else if(Mead_Inflow_yr2_df[i, 4]==1){
    x = "Shortage - Level 1"
  } else if(Mead_Inflow_yr2_df[i, 4]==2){
    x = "Shortage - Level 2"
  } else if(Mead_Inflow_yr2_df[i, 4]==3){
    x = "Shortage - Level 3"
  }
  Operations2 <- c(Operations2, x)
}

Tier_colors2 <- c("#ddd6ac","#0072B2", "#33CC33", "#E69F00", "#CC6666")
names(Tier_colors2) <- c("Surplus","Normal", "Shortage - Level 1", "Shortage - Level 2", "Shortage - Level 3")
manual_scale2 <- scale_fill_manual(name = paste("CY", Next_WY + 1, "Operating Condition"), values = Tier_colors2, guide = guide_legend(override.aes = list(pattern = "none")))
manual_scale3 <- scale_fill_manual(name = paste("CY", Next_WY + 2, "Operating Condition"), values = Tier_colors2, guide = guide_legend(override.aes = list(pattern = "none")))

Mead_Inflow_yr_df$OrderedInflow <- reorder(Mead_Inflow_yr_df$Trace_Years, Mead_Inflow_yr_df$Inflow)
Mead_Inflow_yr_df.melt <- melt(Mead_Inflow_yr_df[,c('Trace_Years', 'Inflow', 'Outflow')], id.vars = 1)
Mead_Inflow_yr_df.melt$Trace_Years <- factor(Mead_Inflow_yr_df.melt$Trace_Years, levels = levels(Mead_Inflow_yr_df$OrderedInflow))
Mead_Flow <- cbind( Mead_Inflow_yr_df.melt, Operations = rep(Operations, time = 2))

Mead_Inflow_yr2_df$OrderedInflow <- reorder(Mead_Inflow_yr2_df$Trace_Years, Mead_Inflow_yr2_df$Inflow)
Mead_Inflow_yr2_df.melt <- melt(Mead_Inflow_yr2_df[,c('Trace_Years', 'Inflow', 'Outflow')], id.vars = 1)
Mead_Inflow_yr2_df.melt$Trace_Years <- factor(Mead_Inflow_yr2_df.melt$Trace_Years, levels = levels(Mead_Inflow_yr2_df$OrderedInflow))
Mead_Flow2 <- cbind( Mead_Inflow_yr2_df.melt, Operations = rep(Operations2, time = 2))

ggplot(Mead_Flow, aes(x = Trace_Years, y = value)) + 
  geom_col_pattern(aes(fill = Operations, pattern = variable, alpha = variable), colour = "black",
                   pattern_fill = "black",
                   pattern_angle = 45,
                   pattern_density = 0.05,
                   pattern_spacing = 0.02,
                   position = 'identity') +
  scale_alpha_manual(values = c(1,0.3), name = "Flow") + 
  scale_pattern_manual(values = c("none", "stripe"), guide = guide_legend(override.aes = list(fill = "grey100")), name = "Flow") + manual_scale2 +
  labs(x = "Hydrologic Trace", y = "Mead Inflow (1,000 AF)") + theme(axis.text.x = element_text(angle = 90, vjust=0.5)) + ggtitle(paste("Annual Mead Analysis based on CY", Next_WY, "Inflow and Outflow Volumes")) + 
  coord_cartesian(ylim = c(5000, 11000)) + scale_y_continuous(breaks = c(5000,7000,9000,11000))

ggplot(Mead_Flow2, aes(x = Trace_Years, y = value)) + 
  geom_col_pattern(aes(fill = Operations, pattern = variable, alpha = variable), colour = "black",
                   pattern_fill = "black",
                   pattern_angle = 45,
                   pattern_density = 0.05,
                   pattern_spacing = 0.02,
                   position = 'identity') +
  scale_alpha_manual(values = c(1,0.3), name = "Flow") + 
  scale_pattern_manual(values = c("none", "stripe"), guide = guide_legend(override.aes = list(fill = "grey100")), name = "Flow") + manual_scale3 +
  labs(x = "Hydrologic Trace", y = "Mead Inflow (1,000 AF)") + theme(axis.text.x = element_text(angle = 90, vjust=0.5)) + ggtitle(paste("Annual Mead Analysis based on CY", Next_WY + 1, "Inflow and Outflow Volumes")) + 
  coord_cartesian(ylim = c(5000, 14000)) + scale_y_continuous(breaks = c(5000,7000,9000,11000, 13000, 15000))


#Annual Mead Inflow Analysis - Only Inflow plotted, No outflow

#Mead_Inflow <- as.data.frame(read_excel("EnsembleOutput.xlsx", sheet = "Mead.Inflow"))
#Mead_years <- as.numeric(format(as.Date(Mead_Inflow[,1]), '%Y'))
#Mead_Inflow_df <- cbind(Mead_years, Mead_Inflow[-1])
#Mead_Inflow_yr <- aggregate(.~Mead_years, data = Mead_Inflow_df, FUN=sum)
#rownames(Mead_Inflow_yr) <- Mead_Inflow_yr[,1]

#LCShortage <- as.data.frame(read_excel("EnsembleOutput.xlsx", sheet = "Shortage.Shortage Flag"))
#rownames(LCShortage) <- LCShortage[,1]
#LCSurplus <- as.data.frame(read_excel("EnsembleOutput.xlsx", sheet = "Surplus.AnnualSurplusFlag"))
#rownames(LCSurplus) <- LCSurplus[,1]

#Mead_Inflow_yr_df <- data.frame(Trace_Years = as.character(t(Years)), NextCY_Inflow = as.numeric(Mead_Inflow_yr[as.character(Next_WY),Traces]), ShortageFlag = t(LCShortage[as.character(Next_WY + 1),Traces]), SurplusFlag = t(LCSurplus[as.character(Next_WY + 1),Traces]))
#Mead_Inflow_yr2_df <- data.frame(Trace_Years = as.character(t(Years)), NextCY_Inflow2 = as.numeric(Mead_Inflow_yr[as.character(Next_WY+1),Traces]), ShortageFlag = t(LCShortage[as.character(Next_WY + 2),Traces]), SurplusFlag = t(LCSurplus[as.character(Next_WY + 2),Traces]))

#Operations <- character()
#for(i in 1:30){
#  if(Mead_Inflow_yr_df[i, 3]==0 & Mead_Inflow_yr_df[i, 4]==1){
#    x = "Surplus"
#  } else if(Mead_Inflow_yr_df[i, 3]==0 & Mead_Inflow_yr_df[i, 4]==0){
#    x = "Normal"
#  } else if(Mead_Inflow_yr_df[i, 3]==1){
#    x = "Shortage - Level 1"
#  } else if(Mead_Inflow_yr_df[i, 3]==2){
#    x = "Shortage - Level 2"
#  } else if(Mead_Inflow_yr_df[i, 3]==3){
#    x = "Shortage - Level 3"
#  }
#  Operations <- c(Operations, x)
#}

#Operations2 <- character()
#for(i in 1:30){
#  if(Mead_Inflow_yr2_df[i, 3]==0 & Mead_Inflow_yr2_df[i, 4]==1){
#    x = "Surplus"
#  } else if(Mead_Inflow_yr2_df[i, 3]==0 & Mead_Inflow_yr2_df[i, 4]==0){
#    x = "Normal"
#  } else if(Mead_Inflow_yr2_df[i, 3]==1){
#    x = "Shortage - Level 1"
#  } else if(Mead_Inflow_yr2_df[i, 3]==2){
#    x = "Shortage - Level 2"
#  } else if(Mead_Inflow_yr2_df[i, 3]==3){
#    x = "Shortage - Level 3"
#  }
#  Operations2 <- c(Operations2, x)
#}

#Tier_colors2 <- c("#ddd6ac","#0072B2", "#33CC33", "#E69F00", "#CC6666")
#names(Tier_colors2) <- c("Surplus","Normal", "Shortage - Level 1", "Shortage - Level 2", "Shortage - Level 3")
#manual_scale2 <- scale_fill_manual(name = paste("CY", Next_WY + 1, "Operating Condition"), values = Tier_colors2)
#manual_scale3 <- scale_fill_manual(name = paste("CY", Next_WY + 2, "Operating Condition"), values = Tier_colors2)

#ggplot(Mead_Inflow_yr_df, aes(fct_reorder(Mead_Inflow_yr_df[,"Trace_Years"], NextCY_Inflow), NextCY_Inflow)) + geom_bar(stat="identity", aes(fill = Operations)) + manual_scale2 + labs(x = "Hydrologic Trace", y = "Mead Inflow (1,000 AF)") + theme(axis.text.x = element_text(angle = 90)) + ggtitle(paste("Annual Mead Inflow Analysis based on CY", Next_WY, "Inflow Volumes")) + coord_cartesian(ylim = c(5000, 11000)) + scale_y_continuous(breaks = c(5000,7000,9000,11000)) + theme(axis.text = element_text(size = 12), axis.title = element_text(size = 14), plot.title = element_text(size = 16), legend.text = element_text(size = 12), legend.title = element_text(size = 12))

#ggplot(Mead_Inflow_yr2_df, aes(fct_reorder(Mead_Inflow_yr2_df[,"Trace_Years"], NextCY_Inflow2), NextCY_Inflow2)) + geom_bar(stat="identity", aes(fill = Operations2)) + manual_scale3 + labs(x = "Hydrologic Trace", y = "Mead Inflow (1,000 AF)") + theme(axis.text.x = element_text(angle = 90)) + ggtitle(paste("Annual Mead Inflow Analysis based on CY", Next_WY + 1, "Inflow Volumes")) + coord_cartesian(ylim = c(5000, 11000)) + scale_y_continuous(breaks = c(5000,7000,9000,11000)) + theme(axis.text = element_text(size = 12), axis.title = element_text(size = 14), plot.title = element_text(size = 16), legend.text = element_text(size = 12), legend.title = element_text(size = 12))


#Mead Stacked Bar Charts - Shortage Condition

LCShortage <- as.data.frame(read_excel("EnsembleOutput.xlsx", sheet = "Shortage.Shortage Flag"))
rownames(LCShortage) <- LCShortage[,1]
LCShortage_lm <- as.data.frame(read_excel(Last_month_file, sheet = "Shortage.Shortage Flag"))
rownames(LCShortage_lm) <- LCShortage_lm[,1]
Year <- c(as.character(Next_WY), as.character(Next_WY+1), as.character(Next_WY+2), as.character(Next_WY+3), as.character(Next_WY+4))

LCSurplus <- as.data.frame(read_excel("EnsembleOutput.xlsx", sheet = "Surplus.AnnualSurplusFlag"))
rownames(LCSurplus) <- LCSurplus[,1]
LCSurplus_lm <- as.data.frame(read_excel(Last_month_file, sheet = "Surplus.AnnualSurplusFlag"))
rownames(LCSurplus_lm) <- LCSurplus_lm[,1]

TSum <- function(x, y, z){
  sum(x[y, Traces]==z)
}

LC_Condition <- c('Surplus','Normal', 'Shortage - Level 1', 'Shortage - Level 2', 'Shortage - Level 3')
Year_new = c("2023","2024","2025","2026","2027")
LCShortage_df <- data.frame(ESPRun = rep(c(Current_month, Previous_month), each = 5), 
                            Condition = rep(LC_Condition), 
                            Year_data = rep(Year_new, each = 10), 
    Trace_data = c(TSum(LCSurplus,"2023",1),(TSum(LCShortage, "2023",0)-TSum(LCSurplus,"2023",1)),
                   TSum(LCShortage, "2023",1),TSum(LCShortage, "2023",2),
                   TSum(LCShortage, "2023",3), TSum(LCSurplus_lm,"2023",1),
                   TSum(LCShortage_lm, "2023",0),(TSum(LCShortage_lm, "2023",1)-TSum(LCShortage_lm, "2023",0)),
                   TSum(LCShortage_lm, "2023",2),TSum(LCShortage_lm, "2023",3),
                   TSum(LCSurplus,"2024",1), (TSum(LCShortage,"2024",0)-TSum(LCSurplus,"2024",1)),
                   TSum(LCShortage,"2024",1), TSum(LCShortage,"2024",2), TSum(LCShortage,"2024",3),
                   TSum(LCSurplus_lm,"2024",1), (TSum(LCShortage_lm,"2024",0)-TSum(LCSurplus_lm,"2024",1)), 
                   TSum(LCShortage_lm,"2024",1), TSum(LCShortage_lm,"2024",2), TSum(LCShortage_lm,"2024",3),
                   TSum(LCSurplus,"2025",1), (TSum(LCShortage,"2025",0)-TSum(LCSurplus,"2025",1)), 
                   TSum(LCShortage,"2025",1), TSum(LCShortage,"2025",2), TSum(LCShortage,"2025",3),
                   TSum(LCSurplus_lm,"2025",1), (TSum(LCShortage_lm,"2025",0)-TSum(LCSurplus_lm,"2025",1)), 
                   TSum(LCShortage_lm,"2025",1), TSum(LCShortage_lm,"2025",2), TSum(LCShortage_lm,"2025",3),
                   TSum(LCSurplus,"2026",1), (TSum(LCShortage,"2026",0)-TSum(LCSurplus,"2026",1)), 
                   TSum(LCShortage,"2026",1), TSum(LCShortage,"2026",2), TSum(LCShortage,"2026",3),
                   TSum(LCSurplus_lm,"2026",1), (TSum(LCShortage_lm,"2026",0)-TSum(LCSurplus_lm,"2026",1)), 
                   TSum(LCShortage_lm,"2026",1), TSum(LCShortage_lm,"2026",2), TSum(LCShortage_lm,"2026",3),
                   TSum(LCSurplus,"2027",1), (TSum(LCShortage,"2027",0)-TSum(LCSurplus,"2027",1)),
                   TSum(LCShortage,"2027",1), TSum(LCShortage,"2027",2), TSum(LCShortage,"2027",3),
                   TSum(LCSurplus_lm,"2027",1), (TSum(LCShortage_lm,"2027",0)-TSum(LCSurplus_lm,"2027",1)),
                   TSum(LCShortage_lm,"2027",1), TSum(LCShortage_lm,"2027",2), TSum(LCShortage_lm,"2027",3)))

#Figure to use with no shading or note about post-2026 operations:

#ggplot(LCShortage_df, aes(x = ESPRun, y = Trace_data, fill = Condition)) + geom_bar(position='stack', stat='identity') + theme_bw() + facet_grid(~Year_data, scales = "free_x") + labs(x = ' ',y = "Number of Traces") + theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) + scale_y_continuous(breaks = seq(0,35, by =5), expand = c(0,0)) + scale_fill_manual(values = c('#e3daa6', '#a6cee3','#1f78b4','#b2df8a','#33a02c'), breaks = LC_Condition) + ggtitle("Lower Basin Operating Condition") + theme(axis.text = element_text(size = 12), axis.title = element_text(size = 14), plot.title = element_text(size = 16), legend.text = element_text(size = 12), legend.title = element_text(size = 12))

#Figure to use to include shading and note about post-2026 operations:

years_to_exclude = c(2023) # Add years here as a comma separated list to exclude them from the figure below

ggplot(subset(LCShortage_df, !Year_data %in% years_to_exclude), aes(x = ESPRun, y = Trace_data, fill = Condition)) + geom_bar(position='stack', stat='identity') + theme_bw() + facet_grid(~Year_data, scales = "free_x") + labs(x = ' ',y = "Number of Traces") + theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) + scale_y_continuous(breaks = seq(0,35, by =5), expand = c(0,0)) + geom_rect(data = subset(LCShortage_df, Year_data > 2026), aes(xmin=-Inf, xmax = Inf, ymin = 0, ymax = Inf), fill = 'black', alpha = 0.03) + scale_fill_manual(values = c('#ddd6ac', '#a6cee3','#1f78b4','#b2df8a','#33a02c'), breaks = LC_Condition) + ggtitle(bquote("Lower Basin Operating Condition")) + labs(caption = bquote('Note: For modeling purposes, these projections assume a continuation of the Interim Guidelines, DCP and Minute 323 \nbeyond 2026. These agreements expire at the end of the 2026, and Reclamation is beginning a process \nto develop operating strategies for post-2026.')) + theme(plot.caption=element_text(hjust = 0, size = 10))


```
